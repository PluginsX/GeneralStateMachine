<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>属性面板调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            gap: 20px;
        }
        .main-content {
            flex: 1;
        }
        .property-panel {
            width: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f9f9f9;
        }
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .test-node {
            background: #e7f3ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <h1>属性面板调试</h1>
        
        <div class="debug-info">
            <h3>调试信息</h3>
            <div id="debug-output">点击下方按钮测试属性面板...</div>
        </div>

        <div>
            <h3>测试操作</h3>
            <button onclick="createTestNode()">创建测试节点</button>
            <button onclick="createTestConnection()">创建测试连线</button>
            <button onclick="testSimpleObject()">测试简单对象</button>
            <button onclick="testPropertyPanel()">测试属性面板</button>
            <button onclick="testEmptySelection()">测试空选择</button>
            <button onclick="testMultipleSelection()">测试多选</button>
            <button onclick="clearDebugInfo()">清空调试信息</button>
        </div>

        <div id="test-objects"></div>
    </div>

    <aside class="property-panel" id="property-panel-container">
        <h2>属性面板</h2>
        <!-- 属性面板将在这里渲染 -->
    </aside>

    <!-- 加载依赖脚本 -->
    <script src="src/ui/propertyPanel/utils/TypeRegistry.js"></script>
    <script src="src/ui/propertyPanel/utils/EventEmitter.js"></script>
    <script src="src/ui/propertyPanel/handlers/ObjectBaseHandler.js"></script>
    <script src="src/ui/propertyPanel/factory/ComponentFactory.js"></script>
    <script src="src/ui/propertyPanel/reflection/PropertyReflection.js"></script>
    <script src="src/ui/propertyPanel/managers/PropertyPanelManager.js"></script>
    <script src="src/ui/propertyPanel/managers/PropertyPanelAdapter.js"></script>

    <script>

        let propertyPanelManager;
        let propertyPanelAdapter;
        let testNodes = [];
        let testConnections = [];

        // 初始化属性面板
        function initPropertyPanel() {
            try {
                console.log('开始初始化属性面板...');
                const container = document.getElementById('property-panel-container');
                console.log('容器元素:', container);
                
                propertyPanelAdapter = new PropertyPanelAdapter(container);
                console.log('PropertyPanelAdapter创建完成:', propertyPanelAdapter);
                
                propertyPanelAdapter.init();
                console.log('PropertyPanelAdapter初始化完成');
                
                // 设置回调函数
                propertyPanelAdapter.setOnNodeUpdateCallback((nodeId, changes) => {
                    logDebug(`节点更新: ${nodeId}, 变更: ${JSON.stringify(changes)}`);
                });
                
                propertyPanelAdapter.setOnDeleteCallback(() => {
                    logDebug('删除回调被触发');
                });
                
                logDebug('属性面板初始化成功');
            } catch (error) {
                logDebug(`属性面板初始化失败: ${error.message}`);
                console.error('Property panel initialization error:', error);
            }
        }

        // 创建测试节点
        window.createTestNode = function() {
            const testNode = {
                id: `node_${Date.now()}`,
                type: 'node',
                name: `测试节点 ${testNodes.length + 1}`,
                x: Math.random() * 400,
                y: Math.random() * 300,
                width: 120,
                height: 60,
                color: '#ff6b6b',
                text: '节点文本',
                fontSize: 14,
                borderRadius: 8,
                shadowColor: 'rgba(0,0,0,0.2)',
                shadowBlur: 10,
                shadowOffsetX: 2,
                shadowOffsetY: 2,
                visible: true,
                locked: false,
                opacity: 1.0,
                rotation: 0,
                scale: 1.0,
                customProperty: '自定义值',
                numberProperty: 42,
                booleanProperty: true,
                arrayProperty: [1, 2, 3]
            };
            
            testNodes.push(testNode);
            updateTestObjectsDisplay();
            
            // 模拟选择这个节点
            propertyPanelAdapter.update([testNode], testNodes, testConnections);
            
            logDebug(`创建测试节点: ${testNode.id}`);
            logNodeDetails(testNode);
        };

        // 创建测试连线
        window.createTestConnection = function() {
            if (testNodes.length < 2) {
                logDebug('需要至少2个节点才能创建连线');
                return;
            }
            
            const testConnection = {
                id: `conn_${Date.now()}`,
                type: 'connection',
                sourceNodeId: testNodes[0].id,
                targetNodeId: testNodes[1].id,
                name: `测试连线 ${testConnections.length + 1}`,
                color: '#4ecdc4',
                width: 3,
                style: 'solid',
                arrowType: 'arrow',
                visible: true,
                locked: false,
                opacity: 1.0,
                customProperty: '连线自定义值'
            };
            
            testConnections.push(testConnection);
            updateTestObjectsDisplay();
            
            // 模拟选择这条连线
            propertyPanelAdapter.update([testConnection], testNodes, testConnections);
            
            logDebug(`创建测试连线: ${testConnection.id}`);
            logConnectionDetails(testConnection);
        };

        // 测试简单对象
        window.testSimpleObject = function() {
            console.log('=== 测试简单对象 ===');
            
            const simpleObject = {
                name: '测试对象',
                x: 100,
                y: 200,
                width: 50,
                height: 30,
                visible: true,
                type: 'rectangle'
            };
            
            console.log('创建的简单对象:', simpleObject);
            propertyPanelAdapter.update([simpleObject], [], []);
            logDebug('测试简单对象: ' + JSON.stringify(simpleObject));
        };

        // 测试函数
        window.testPropertyPanel = function() {
            console.log('=== 开始测试属性面板 ===');
            
            // 创建一个模拟的节点对象
            const mockNode = {
                id: 'node1',
                type: 'state',
                name: 'State 1',
                x: 100,
                y: 100,
                width: 120,
                height: 60,
                color: '#4CAF50',
                selected: false,
                visible: true,
                data: {
                    description: 'This is a test state node',
                    entry: false,
                    exit: false
                }
            };
            
            console.log('创建的模拟节点:', mockNode);
            
            // 测试属性面板更新
            propertyPanelAdapter.update([mockNode], [mockNode], []);
            logDebug('测试属性面板: ' + JSON.stringify(mockNode));
        };

        // 测试空选择
        window.testEmptySelection = function() {
            propertyPanelAdapter.update([], testNodes, testConnections);
            logDebug('测试空选择');
        };

        // 测试多选
        window.testMultipleSelection = function() {
            if (testNodes.length >= 2) {
                propertyPanelAdapter.update([testNodes[0], testNodes[1]], testNodes, testConnections);
                logDebug('测试多选: 选择了2个节点');
            } else {
                logDebug('需要至少2个节点才能测试多选');
            }
        };

        // 清空调试信息
        window.clearDebugInfo = function() {
            document.getElementById('debug-output').innerHTML = '';
        };

        // 记录调试信息
        function logDebug(message) {
            const debugOutput = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        // 记录节点详细信息
        function logNodeDetails(node) {
            logDebug(`节点详细信息:`);
            logDebug(`- ID: ${node.id}`);
            logDebug(`- 类型: ${node.type}`);
            logDebug(`- 名称: ${node.name}`);
            logDebug(`- 属性数量: ${Object.keys(node).length}`);
            logDebug(`- 所有属性: ${Object.keys(node).join(', ')}`);
            
            // 检查是否有特殊属性
            const specialProps = ['transform', 'style', 'data', 'config'];
            specialProps.forEach(prop => {
                if (node[prop]) {
                    logDebug(`- ${prop}: ${JSON.stringify(node[prop])}`);
                }
            });
        }

        // 记录连线详细信息
        function logConnectionDetails(connection) {
            logDebug(`连线详细信息:`);
            logDebug(`- ID: ${connection.id}`);
            logDebug(`- 类型: ${connection.type}`);
            logDebug(`- 源节点: ${connection.sourceNodeId}`);
            logDebug(`- 目标节点: ${connection.targetNodeId}`);
            logDebug(`- 属性数量: ${Object.keys(connection).length}`);
            logDebug(`- 所有属性: ${Object.keys(connection).join(', ')}`);
        }

        // 更新测试对象显示
        function updateTestObjectsDisplay() {
            const container = document.getElementById('test-objects');
            let html = '<h3>测试对象</h3>';
            
            if (testNodes.length > 0) {
                html += '<h4>节点:</h4>';
                testNodes.forEach(node => {
                    html += `<div class="test-node">
                        <strong>${node.name}</strong> (${node.id})<br>
                        <small>属性: ${Object.keys(node).length}个</small>
                        <button onclick="selectNode('${node.id}')" style="float: right; padding: 2px 8px; font-size: 12px;">选择</button>
                    </div>`;
                });
            }
            
            if (testConnections.length > 0) {
                html += '<h4>连线:</h4>';
                testConnections.forEach(conn => {
                    html += `<div class="test-node">
                        <strong>${conn.name}</strong> (${conn.id})<br>
                        <small>${conn.sourceNodeId} → ${conn.targetNodeId}</small>
                        <button onclick="selectConnection('${conn.id}')" style="float: right; padding: 2px 8px; font-size: 12px;">选择</button>
                    </div>`;
                });
            }
            
            container.innerHTML = html;
        }

        // 选择特定节点
        window.selectNode = function(nodeId) {
            const node = testNodes.find(n => n.id === nodeId);
            if (node) {
                propertyPanelAdapter.update([node], testNodes, testConnections);
                logDebug(`选择节点: ${node.name}`);
            }
        };

        // 选择特定连线
        window.selectConnection = function(connId) {
            const conn = testConnections.find(c => c.id === connId);
            if (conn) {
                propertyPanelAdapter.update([conn], testNodes, testConnections);
                logDebug(`选择连线: ${conn.name}`);
            }
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('页面加载完成，开始初始化属性面板...');
            initPropertyPanel();
        });
    </script>
</body>
</html>