<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨æ’åˆ—åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .test-item {
            margin: 5px 0;
            padding: 5px;
        }
        .test-item.pass {
            color: #28a745;
        }
        .test-item.fail {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª è‡ªåŠ¨æ’åˆ—åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•æ§åˆ¶</h2>
            <button class="test-button" onclick="runBasicTest()">åŸºç¡€è‡ªåŠ¨æ’åˆ—æµ‹è¯•</button>
            <button class="test-button" onclick="runComplexTest()">å¤æ‚çŠ¶æ€æœºæµ‹è¯•</button>
            <button class="test-button" onclick="runRealTimeTest()">å®æ—¶æ’åˆ—å¼€å…³æµ‹è¯•</button>
            <button class="test-button danger" onclick="clearEditor()">æ¸…ç©ºç¼–è¾‘å™¨</button>
            
            <div id="status" class="status info" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="test-results" class="test-results">
                <div class="test-item">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”— ç¼–è¾‘å™¨é“¾æ¥</h2>
            <a href="http://localhost:8000" target="_blank">æ‰“å¼€çŠ¶æ€æœºç¼–è¾‘å™¨</a>
        </div>
    </div>

    <script>
        let testResults = [];
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('test-results');
        
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        function addTestResult(testName, passed, details = '') {
            testResults.push({ testName, passed, details });
            updateResultsDisplay();
        }
        
        function updateResultsDisplay() {
            resultsDiv.innerHTML = testResults.map(result => 
                `<div class="test-item ${result.passed ? 'pass' : 'fail'}">
                    ${result.passed ? 'âœ…' : 'âŒ'} ${result.testName}
                    ${result.details ? ` - ${result.details}` : ''}
                </div>`
            ).join('');
        }
        
        function waitForEditor() {
            return new Promise((resolve) => {
                const checkEditor = () => {
                    const editorWindow = window.open('', 'editor');
                    if (editorWindow && editorWindow.editor && editorWindow.editor.isReady) {
                        resolve(editorWindow.editor);
                    } else {
                        setTimeout(checkEditor, 500);
                    }
                };
                checkEditor();
            });
        }
        
        async function runBasicTest() {
            showStatus('å¼€å§‹åŸºç¡€è‡ªåŠ¨æ’åˆ—æµ‹è¯•...', 'info');
            
            try {
                // ç›´æ¥åœ¨å½“å‰çª—å£ä¸­æµ‹è¯•ï¼ˆå¦‚æœç¼–è¾‘å™¨å·²åŠ è½½ï¼‰
                if (!window.editor) {
                    showStatus('è¯·å…ˆæ‰“å¼€ç¼–è¾‘å™¨é¡µé¢', 'error');
                    return;
                }
                
                const editor = window.editor;
                
                // æ¸…ç©ºç°æœ‰èŠ‚ç‚¹
                editor.clearAll();
                
                // åˆ›å»ºç®€å•æµ‹è¯•èŠ‚ç‚¹
                const nodes = [
                    editor.createNode(100, 100, 'å¼€å§‹'),
                    editor.createNode(300, 100, 'å¤„ç†'),
                    editor.createNode(500, 100, 'ç»“æŸ')
                ];
                
                nodes.forEach(node => editor.addNode(node));
                
                // åˆ›å»ºè¿æ¥
                if (nodes.length >= 3) {
                    editor.createConnection(nodes[0], nodes[1]);
                    editor.createConnection(nodes[1], nodes[2]);
                }
                
                // è®°å½•æ’åˆ—å‰ä½ç½®
                const beforePositions = nodes.map(n => ({
                    name: n.name,
                    x: n.transform.position.x,
                    y: n.transform.position.y
                }));
                
                // æ‰§è¡Œè‡ªåŠ¨æ’åˆ—
                editor.arrangeNodesWithForceLayout();
                
                // ç­‰å¾…æ’åˆ—å®Œæˆ
                setTimeout(() => {
                    const afterPositions = nodes.map(n => ({
                        name: n.name,
                        x: n.transform.position.x,
                        y: n.transform.position.y
                    }));
                    
                    // æ£€æŸ¥æ˜¯å¦æŒ‰å±‚çº§æ’åˆ—
                    const isLevelArranged = afterPositions.every((pos, index) => {
                        if (index === 0) return true;
                        return pos.y >= afterPositions[index - 1].y;
                    });
                    
                    addTestResult('åŸºç¡€è‡ªåŠ¨æ’åˆ—', isLevelArranged, 
                        `èŠ‚ç‚¹æ•°: ${nodes.length}, å±‚çº§æ’åˆ—: ${isLevelArranged}`);
                    
                    showStatus('åŸºç¡€è‡ªåŠ¨æ’åˆ—æµ‹è¯•å®Œæˆ', isLevelArranged ? 'success' : 'error');
                }, 1000);
                
            } catch (error) {
                addTestResult('åŸºç¡€è‡ªåŠ¨æ’åˆ—', false, error.message);
                showStatus('åŸºç¡€æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function runComplexTest() {
            showStatus('å¼€å§‹å¤æ‚çŠ¶æ€æœºæµ‹è¯•...', 'info');
            
            try {
                if (!window.editor) {
                    showStatus('è¯·å…ˆæ‰“å¼€ç¼–è¾‘å™¨é¡µé¢', 'error');
                    return;
                }
                
                const editor = window.editor;
                editor.clearAll();
                
                // åˆ›å»ºå¤æ‚çš„çŠ¶æ€æœº
                const nodeNames = ['åˆå§‹', 'å¾…å¤„ç†', 'å¤„ç†ä¸­', 'éªŒè¯', 'å®Œæˆ', 'å¤±è´¥', 'é‡è¯•', 'å–æ¶ˆ'];
                const nodes = nodeNames.map((name, index) => {
                    const node = editor.createNode(100 + index * 50, 100 + (index % 3) * 50, name);
                    editor.addNode(node);
                    return node;
                });
                
                // åˆ›å»ºå¤æ‚è¿æ¥
                if (nodes.length >= 8) {
                    editor.createConnection(nodes[0], nodes[1]); // åˆå§‹->å¾…å¤„ç†
                    editor.createConnection(nodes[1], nodes[2]); // å¾…å¤„ç†->å¤„ç†ä¸­
                    editor.createConnection(nodes[2], nodes[3]); // å¤„ç†ä¸­->éªŒè¯
                    editor.createConnection(nodes[3], nodes[4]); // éªŒè¯->å®Œæˆ
                    editor.createConnection(nodes[3], nodes[5]); // éªŒè¯->å¤±è´¥
                    editor.createConnection(nodes[5], nodes[6]); // å¤±è´¥->é‡è¯•
                    editor.createConnection(nodes[6], nodes[1]); // é‡è¯•->å¾…å¤„ç†
                    editor.createConnection(nodes[2], nodes[7]); // å¤„ç†ä¸­->å–æ¶ˆ
                }
                
                // æ‰§è¡Œè‡ªåŠ¨æ’åˆ—
                editor.arrangeNodesWithForceLayout();
                
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦å½¢æˆäº†åˆç†çš„å±‚çº§ç»“æ„
                    const levels = new Set();
                    nodes.forEach(node => {
                        levels.add(Math.round(node.transform.position.y / 100));
                    });
                    
                    const hasMultipleLevels = levels.size > 1;
                    addTestResult('å¤æ‚çŠ¶æ€æœºæ’åˆ—', hasMultipleLevels, 
                        `èŠ‚ç‚¹æ•°: ${nodes.length}, å±‚çº§æ•°: ${levels.size}`);
                    
                    showStatus('å¤æ‚çŠ¶æ€æœºæµ‹è¯•å®Œæˆ', hasMultipleLevels ? 'success' : 'error');
                }, 1000);
                
            } catch (error) {
                addTestResult('å¤æ‚çŠ¶æ€æœºæ’åˆ—', false, error.message);
                showStatus('å¤æ‚æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function runRealTimeTest() {
            showStatus('å¼€å§‹å®æ—¶æ’åˆ—å¼€å…³æµ‹è¯•...', 'info');
            
            try {
                if (!window.editor) {
                    showStatus('è¯·å…ˆæ‰“å¼€ç¼–è¾‘å™¨é¡µé¢', 'error');
                    return;
                }
                
                const editor = window.editor;
                const initialState = editor.isRealTimeArrangeActive || false;
                
                // åˆ‡æ¢å®æ—¶æ’åˆ—
                editor.handleRealTimeArrange();
                const newState = editor.isRealTimeArrangeActive || false;
                
                // åˆ‡æ¢å›æ¥
                editor.handleRealTimeArrange();
                const finalState = editor.isRealTimeArrangeActive || false;
                
                const toggleWorks = newState !== initialState && finalState === initialState;
                addTestResult('å®æ—¶æ’åˆ—å¼€å…³', toggleWorks, 
                    `åˆå§‹: ${initialState} -> åˆ‡æ¢å: ${newState} -> æ¢å¤: ${finalState}`);
                
                showStatus('å®æ—¶æ’åˆ—å¼€å…³æµ‹è¯•å®Œæˆ', toggleWorks ? 'success' : 'error');
                
            } catch (error) {
                addTestResult('å®æ—¶æ’åˆ—å¼€å…³', false, error.message);
                showStatus('å®æ—¶æ’åˆ—æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function clearEditor() {
            try {
                if (window.editor) {
                    window.editor.clearAll();
                    showStatus('ç¼–è¾‘å™¨å·²æ¸…ç©º', 'success');
                } else {
                    showStatus('ç¼–è¾‘å™¨æœªæ‰¾åˆ°', 'error');
                }
            } catch (error) {
                showStatus('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            showStatus('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œè¯·ç¡®ä¿ç¼–è¾‘å™¨é¡µé¢åœ¨åŒä¸€æµè§ˆå™¨ä¸­æ‰“å¼€', 'info');
        });
    </script>
</body>
</html>