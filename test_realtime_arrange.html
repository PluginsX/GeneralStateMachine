<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3åŠ›å¯¼å‘å›¾å®æ—¶è‡ªåŠ¨æ’åˆ—æµ‹è¯•</title>
    <!-- D3.js åº“ -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            height: 80vh;
            gap: 20px;
        }
        
        .canvas-container {
            flex: 1;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        canvas {
            display: block;
            cursor: grab;
        }
        
        canvas:active {
            cursor: grabbing;
        }
        
        .controls {
            width: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* é€‰æ‹©æ¡†æ ·å¼ */
        .selection-rectangle {
            position: absolute;
            border: 1px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.1);
            pointer-events: none;
            z-index: 1000;
        }
        
        /* ç¼©æ”¾çº§åˆ«æ˜¾ç¤º */
        #zoom-level {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        /* éšè—çš„å¿…è¦DOMå…ƒç´  */
        .hidden-elements {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ D3åŠ›å¯¼å‘å›¾å®æ—¶è‡ªåŠ¨æ’åˆ—æµ‹è¯•</h1>
    
    <div class="container">
        <div class="canvas-container">
            <canvas id="canvas"></canvas>
            <div class="selection-rectangle"></div>
            <div id="zoom-level"></div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>ğŸ“Š æµ‹è¯•çŠ¶æ€</h3>
                <div id="status" class="status info">å‡†å¤‡å°±ç»ª</div>
            </div>
            
            <div class="control-group">
                <h3>ğŸ¯ èŠ‚ç‚¹æ“ä½œ</h3>
                <button class="btn-primary" onclick="createTestNodes()">åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹</button>
                <button class="btn-success" onclick="createComplexGraph()">åˆ›å»ºå¤æ‚å›¾</button>
                <button class="btn-danger" onclick="clearEditor()">æ¸…ç©ºç¼–è¾‘å™¨</button>
            </div>
            
            <div class="control-group">
                <h3>âš¡ D3åŠ›å¯¼å‘å›¾</h3>
                <button class="btn-success" onclick="startRealTimeArrange()">å¯åŠ¨åŠ›å¯¼å‘å›¾</button>
                <button class="btn-warning" onclick="stopRealTimeArrange()">åœæ­¢åŠ›å¯¼å‘å›¾</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
                <ul style="font-size: 14px; padding-left: 20px;">
                    <li>ç‚¹å‡»"åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹"ç”Ÿæˆ5ä¸ªèŠ‚ç‚¹</li>
                    <li>ç‚¹å‡»"åˆ›å»ºå¤æ‚å›¾"ç”Ÿæˆå¤æ‚ç½‘ç»œ</li>
                    <li>ç‚¹å‡»"å¯åŠ¨åŠ›å¯¼å‘å›¾"å¼€å§‹D3åŠ›å¯¼å‘å›¾æ¨¡æ‹Ÿ</li>
                    <li>æ‹–åŠ¨èŠ‚ç‚¹æŸ¥çœ‹å®æ—¶è‡ªåŠ¨é‡æ’æ•ˆæœ</li>
                    <li>èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ’æ–¥å¹¶ä¿æŒè¿æ¥è·ç¦»</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- éšè—çš„å¿…è¦DOMå…ƒç´  -->
    <div class="hidden-elements">
        <!-- èœå•æŒ‰é’® -->
        <button id="new-project"></button>
        <button id="open-project"></button>
        <button id="import-md"></button>
        <button id="import-json"></button>
        <button id="import-yaml"></button>
        <button id="export-md"></button>
        <button id="export-image"></button>
        <button id="save-project"></button>
        <button id="undo"></button>
        <button id="redo"></button>
        <button id="toggle-theme"></button>
        
        <!-- é€‰æ‹©ç­›é€‰å™¨ -->
        <select id="selection-filter">
            <option value="all">all</option>
            <option value="nodes">nodes</option>
            <option value="connections">connections</option>
        </select>
        
        <!-- ç¼©æ”¾æ§åˆ¶ -->
        <button id="zoom-in"></button>
        <button id="zoom-out"></button>
        
        <!-- è‡ªåŠ¨æ’åˆ— -->
        <button id="auto-arrange-btn"></button>
        <button id="real-time-arrange"></button>
        
        <!-- å±æ€§é¢æ¿ -->
        <button id="update-node"></button>
        <button id="delete-node"></button>
        <button id="add-condition"></button>
        <button id="delete-connection"></button>
        <button id="add-text"></button>
        
        <!-- èŠ‚ç‚¹å±æ€§ -->
        <input id="node-autosize" type="checkbox">
        
        <!-- æ–‡ä»¶è¾“å…¥ -->
        <input id="file-input" type="file">
        <input id="json-input" type="file">
        <input id="yaml-input" type="file">
        <input id="project-input" type="file">
        
        <!-- å·¥å…·æ æ‹–æ‹½ -->
        <div class="tool-item" data-type="node"></div>
        <div class="tool-item" data-type="connection"></div>
        
        <!-- å±æ€§é¢æ¿ç›¸å…³å…ƒç´  -->
        <div id="node-properties">
            <input id="node-name" type="text">
            <input id="node-description" type="text">
            <input id="node-group" type="text">
            <input id="node-width" type="number">
            <input id="node-height" type="number">
            <input id="node-autosize" type="checkbox">
            <input id="node-color" type="color">
            <button id="node-color-reset">é‡ç½®é¢œè‰²</button>
            <input id="node-force-charge" type="number">
            <input id="node-force-collide-radius" type="number">
            <input id="node-force-strength" type="number">
            <input id="node-fixed-position" type="checkbox">
            <div id="outgoing-connections"></div>
            <div id="incoming-connections"></div>
        </div>
        
        <div id="connection-properties">
            <!-- è¿çº¿å±æ€§ç›¸å…³å…ƒç´  -->
        </div>
        
        <div id="no-selection">
            <!-- æ— é€‰æ‹©æ—¶çš„æ˜¾ç¤ºå…ƒç´  -->
        </div>
        
        <!-- å…¶ä»–å¯èƒ½çš„å¿…è¦å…ƒç´  -->
        <div id="menu"></div>
        <div id="properties-panel"></div>
    </div>
    
    <script type="module">
        import NodeGraphEditor from './src/core/editor.js';
        
        // åˆ›å»ºç¼–è¾‘å™¨å®ä¾‹
        const editor = new NodeGraphEditor('canvas');
        
        // å°†ç¼–è¾‘å™¨å®ä¾‹æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.editor = editor;
        
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹
        window.createTestNodes = function() {
            try {
                updateStatus('æ­£åœ¨åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹...', 'info');
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                editor.clearAll();
                
                // åˆ›å»º5ä¸ªæµ‹è¯•èŠ‚ç‚¹
                const nodeNames = ['èŠ‚ç‚¹A', 'èŠ‚ç‚¹B', 'èŠ‚ç‚¹C', 'èŠ‚ç‚¹D', 'èŠ‚ç‚¹E'];
                const nodes = nodeNames.map((name, index) => {
                    const node = editor.createNode(100 + index * 150, 200, name);
                    editor.addNode(node);
                    return node;
                });
                
                // åˆ›å»ºä¸€äº›è¿æ¥
                if (nodes.length >= 5) {
                    const connections = [
                        [0, 1], [1, 2], [2, 3], [3, 4], [0, 4] // ç®€å•çš„çº¿æ€§è¿æ¥åŠ ä¸€ä¸ªé—­åˆè¿æ¥
                    ];
                    
                    connections.forEach(([sourceIdx, targetIdx]) => {
                        if (sourceIdx < nodes.length && targetIdx < nodes.length) {
                            try {
                                const conn = editor.createConnection(nodes[sourceIdx], nodes[targetIdx]);
                                editor.addConnection(conn);
                            } catch (error) {
                                console.warn(`è·³è¿‡é‡å¤è¿æ¥: ${nodes[sourceIdx].name} -> ${nodes[targetIdx].name}`);
                            }
                        }
                    });
                }
                
                updateStatus(`æˆåŠŸåˆ›å»º ${nodes.length} ä¸ªæµ‹è¯•èŠ‚ç‚¹`, 'success');
                
            } catch (error) {
                console.error('åˆ›å»ºèŠ‚ç‚¹å¤±è´¥:', error);
                updateStatus('åˆ›å»ºèŠ‚ç‚¹å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // åˆ›å»ºå¤æ‚å›¾
        window.createComplexGraph = function() {
            try {
                updateStatus('æ­£åœ¨åˆ›å»ºå¤æ‚å›¾...', 'info');
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                editor.clearAll();
                
                // åˆ›å»º10ä¸ªèŠ‚ç‚¹
                const nodes = [];
                for (let i = 0; i < 10; i++) {
                    const x = 100 + (i % 5) * 150;
                    const y = 100 + Math.floor(i / 5) * 150;
                    const node = editor.createNode(x, y, `èŠ‚ç‚¹${String.fromCharCode(65 + i)}`);
                    editor.addNode(node);
                    nodes.push(node);
                }
                
                // åˆ›å»ºå¤æ‚çš„è¿æ¥
                const connections = [
                    [0, 1], [1, 2], [2, 3], [3, 4], // ç¬¬ä¸€è¡Œ
                    [5, 6], [6, 7], [7, 8], [8, 9], // ç¬¬äºŒè¡Œ
                    [0, 5], [1, 6], [2, 7], [3, 8], [4, 9], // å‚ç›´è¿æ¥
                    [0, 2], [1, 3], [5, 7], [6, 8], // å¯¹è§’è¿æ¥
                    [2, 6], [3, 7], [4, 8] // è·¨å±‚è¿æ¥
                ];
                
                const addedConnections = new Set(); // ç”¨äºè·Ÿè¸ªå·²æ·»åŠ çš„è¿æ¥
                
                connections.forEach(([sourceIdx, targetIdx]) => {
                    if (sourceIdx < nodes.length && targetIdx < nodes.length) {
                        const connectionKey = `${sourceIdx}-${targetIdx}`;
                        const reverseConnectionKey = `${targetIdx}-${sourceIdx}`;
                        
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡ç›¸åŒæˆ–åå‘çš„è¿æ¥
                        if (!addedConnections.has(connectionKey) && !addedConnections.has(reverseConnectionKey)) {
                            try {
                                const conn = editor.createConnection(nodes[sourceIdx], nodes[targetIdx]);
                                editor.addConnection(conn);
                                addedConnections.add(connectionKey);
                            } catch (error) {
                                console.warn(`è·³è¿‡é‡å¤è¿æ¥: ${nodes[sourceIdx].name} -> ${nodes[targetIdx].name}`);
                            }
                        }
                    }
                });
                
                updateStatus(`æˆåŠŸåˆ›å»ºå¤æ‚å›¾ï¼š${nodes.length} ä¸ªèŠ‚ç‚¹ï¼Œ${connections.length} æ¡è¿æ¥`, 'success');
                
            } catch (error) {
                console.error('åˆ›å»ºå¤æ‚å›¾å¤±è´¥:', error);
                updateStatus('åˆ›å»ºå¤æ‚å›¾å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // å¯åŠ¨å®æ—¶æ’åˆ—
        window.startRealTimeArrange = function() {
            try {
                updateStatus('æ­£åœ¨å¯åŠ¨å®æ—¶æ’åˆ—...', 'info');
                editor.handleRealTimeArrange();
                updateStatus('å®æ—¶æ’åˆ—å·²å¯åŠ¨', 'success');
            } catch (error) {
                console.error('å¯åŠ¨å®æ—¶æ’åˆ—å¤±è´¥:', error);
                updateStatus('å¯åŠ¨å®æ—¶æ’åˆ—å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // åœæ­¢å®æ—¶æ’åˆ—
        window.stopRealTimeArrange = function() {
            try {
                updateStatus('æ­£åœ¨åœæ­¢å®æ—¶æ’åˆ—...', 'info');
                editor.stopRealTimeArrange();
                updateStatus('å®æ—¶æ’åˆ—å·²åœæ­¢', 'success');
            } catch (error) {
                console.error('åœæ­¢å®æ—¶æ’åˆ—å¤±è´¥:', error);
                updateStatus('åœæ­¢å®æ—¶æ’åˆ—å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æ¸…ç©ºç¼–è¾‘å™¨
        window.clearEditor = function() {
            try {
                editor.clearAll();
                updateStatus('ç¼–è¾‘å™¨å·²æ¸…ç©º', 'info');
            } catch (error) {
                console.error('æ¸…ç©ºç¼–è¾‘å™¨å¤±è´¥:', error);
                updateStatus('æ¸…ç©ºç¼–è¾‘å™¨å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // åˆå§‹åŒ–æ—¶åˆ›å»ºä¸€äº›æµ‹è¯•èŠ‚ç‚¹
        setTimeout(() => {
            createTestNodes();
        }, 1000);
        
        // è®¾ç½®ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            const canvas = document.getElementById('canvas');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            editor.scheduleRender();
        }
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', resizeCanvas);
        
        // åˆå§‹åŒ–ç”»å¸ƒå¤§å°
        resizeCanvas();
    </script>
</body>
</html>