<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自动排列功能测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>自动排列功能测试</h1>
        
        <div class="test-section">
            <h2>测试场景</h2>
            <button class="test-button" onclick="testBasicAutoArrange()">基础自动排列测试</button>
            <button class="test-button" onclick="testComplexAutoArrange()">复杂状态机测试</button>
            <button class="test-button" onclick="testToggleRealTimeArrange()">实时排列开关测试</button>
            <button class="test-button" onclick="clearAllNodes()">清空所有节点</button>
            
            <div id="status" class="status" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>状态机编辑器</h2>
            <iframe src="http://localhost:8000" id="editor-frame"></iframe>
        </div>
    </div>

    <script>
        const iframe = document.getElementById('editor-frame');
        const statusDiv = document.getElementById('status');
        
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${isError ? 'error' : 'success'}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        function waitForEditorReady() {
            return new Promise((resolve) => {
                const checkReady = () => {
                    try {
                        const editorWindow = iframe.contentWindow;
                        if (editorWindow.editor && editorWindow.editor.isReady) {
                            resolve(editorWindow);
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    } catch (e) {
                        setTimeout(checkReady, 100);
                    }
                };
                checkReady();
            });
        }
        
        async function testBasicAutoArrange() {
            try {
                const editorWindow = await waitForEditorReady();
                const editor = editorWindow.editor;
                
                // 创建基础测试节点
                const testNodes = [
                    { name: '开始', x: 100, y: 100 },
                    { name: '处理', x: 300, y: 100 },
                    { name: '结束', x: 500, y: 100 }
                ];
                
                // 清空现有节点
                editor.clearAll();
                
                // 添加测试节点
                testNodes.forEach(nodeData => {
                    const node = editor.createNode(nodeData.x, nodeData.y, nodeData.name);
                    editor.addNode(node);
                });
                
                // 添加连线
                if (editor.nodes.length >= 3) {
                    editor.createConnection(editor.nodes[0], editor.nodes[1]);
                    editor.createConnection(editor.nodes[1], editor.nodes[2]);
                }
                
                // 执行自动排列
                editor.autoArrange();
                
                showStatus('基础自动排列测试完成 - 创建了3个节点并执行树形排列');
                
            } catch (error) {
                showStatus(`基础测试失败: ${error.message}`, true);
            }
        }
        
        async function testComplexAutoArrange() {
            try {
                const editorWindow = await waitForEditorReady();
                const editor = editorWindow.editor;
                
                // 创建复杂的状态机数据
                const complexStateMachine = {
                    Nodes: [
                        '初始状态', '待处理', '处理中', '验证', '完成', '失败',
                        '重试', '超时', '取消', '归档'
                    ],
                    Transitions: [
                        { From: '初始状态', To: '待处理' },
                        { From: '待处理', To: '处理中' },
                        { From: '处理中', To: '验证' },
                        { From: '验证', To: '完成' },
                        { From: '验证', To: '失败' },
                        { From: '失败', To: '重试' },
                        { From: '重试', To: '待处理' },
                        { From: '处理中', To: '超时' },
                        { From: '超时', To: '失败' },
                        { From: '处理中', To: '取消' },
                        { From: '取消', To: '归档' },
                        { From: '完成', To: '归档' },
                        { From: '失败', To: '归档' }
                    ]
                };
                
                // 清空现有节点
                editor.clearAll();
                
                // 导入复杂状态机
                const importService = new editorWindow.ImportService();
                const result = importService.importFromStateMachineJSON(complexStateMachine);
                
                // 添加节点到编辑器
                result.nodes.forEach(node => {
                    editor.addNode(node);
                });
                
                // 添加连线
                result.connections.forEach(conn => {
                    const sourceNode = editor.nodes.find(n => n.id === conn.sourceId);
                    const targetNode = editor.nodes.find(n => n.id === conn.targetNodeId);
                    if (sourceNode && targetNode) {
                        editor.createConnection(sourceNode, targetNode);
                    }
                });
                
                // 执行自动排列
                editor.autoArrange();
                
                showStatus('复杂自动排列测试完成 - 创建了10个节点和13条连线并执行树形排列');
                
            } catch (error) {
                showStatus(`复杂测试失败: ${error.message}`, true);
            }
        }
        
        async function testToggleRealTimeArrange() {
            try {
                const editorWindow = await waitForEditorReady();
                const editor = editorWindow.editor;
                
                // 检查实时排列状态
                const currentState = editor.realTimeArrange || false;
                const newState = !currentState;
                
                // 切换实时排列状态
                if (editorWindow.toggleRealTimeArrange) {
                    editorWindow.toggleRealTimeArrange();
                    showStatus(`实时排列已${newState ? '启用' : '禁用'}`);
                } else {
                    showStatus('实时排列切换功能不可用', true);
                }
                
            } catch (error) {
                showStatus(`实时排列测试失败: ${error.message}`, true);
            }
        }
        
        async function clearAllNodes() {
            try {
                const editorWindow = await waitForEditorReady();
                const editor = editorWindow.editor;
                
                editor.clearAll();
                showStatus('已清空所有节点');
                
            } catch (error) {
                showStatus(`清空节点失败: ${error.message}`, true);
            }
        }
        
        // 页面加载完成后等待编辑器就绪
        window.addEventListener('load', () => {
            setTimeout(() => {
                showStatus('测试页面已加载，可以开始测试自动排列功能');
            }, 2000);
        });
    </script>
</body>
</html>